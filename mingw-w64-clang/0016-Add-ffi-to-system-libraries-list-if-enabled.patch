From cdc1f28fee31e704835d286c9650c79e87b75d6a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Mateusz=20Miku=C5=82a?= <mati865@gmail.com>
Date: Sun, 26 Jul 2020 13:24:05 +0200
Subject: [PATCH] Add ffi to system libraries list if enabled

---
 cmake/config-ix.cmake                          | 11 +++++++++--
 lib/ExecutionEngine/Interpreter/CMakeLists.txt |  4 ----
 lib/Support/CMakeLists.txt                     |  4 ++++
 3 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/cmake/config-ix.cmake b/cmake/config-ix.cmake
index e71585e..1cab540 100644
--- a/cmake/config-ix.cmake
+++ b/cmake/config-ix.cmake
@@ -321,9 +321,16 @@ if( LLVM_ENABLE_FFI )
     message(FATAL_ERROR "libffi includes are not found.")
   endif()
 
-  find_library(FFI_LIBRARY_PATH ffi PATHS ${FFI_LIBRARY_DIR})
+  # If ffi is available in standard locations we prefer to use -lffi in llvm-config
+  # otherwise use absolute path
+  find_library(FFI_LIBRARY_PATH ffi)
   if( NOT FFI_LIBRARY_PATH )
-    message(FATAL_ERROR "libffi is not found.")
+    find_library(FFI_LIBRARY_PATH ffi PATHS ${FFI_LIBRARY_DIR})
+    if( NOT FFI_LIBRARY_PATH )
+      message(FATAL_ERROR "libffi is not found.")
+    endif()
+  else()
+    set(FFI_LIBRARY_PATH ffi CACHE INTERNAL "")
   endif()
 
   list(APPEND CMAKE_REQUIRED_LIBRARIES ${FFI_LIBRARY_PATH})
diff --git a/lib/ExecutionEngine/Interpreter/CMakeLists.txt b/lib/ExecutionEngine/Interpreter/CMakeLists.txt
index b8adea5..44363ef 100644
--- a/lib/ExecutionEngine/Interpreter/CMakeLists.txt
+++ b/lib/ExecutionEngine/Interpreter/CMakeLists.txt
@@ -14,7 +14,3 @@ add_llvm_component_library(LLVMInterpreter
   DEPENDS
   intrinsics_gen
   )
-
-if( LLVM_ENABLE_FFI )
-  target_link_libraries( LLVMInterpreter PRIVATE ${FFI_LIBRARY_PATH} )
-endif()
diff --git a/lib/Support/CMakeLists.txt b/lib/Support/CMakeLists.txt
index ef12af6..14892bb 100644
--- a/lib/Support/CMakeLists.txt
+++ b/lib/Support/CMakeLists.txt
@@ -1,6 +1,10 @@
 set(system_libs)
 if ( LLVM_ENABLE_ZLIB AND HAVE_LIBZ )
   set(system_libs ${system_libs} ${ZLIB_LIBRARIES})
+if( LLVM_ENABLE_FFI )
+  set(system_libs ${system_libs} ${FFI_LIBRARY_PATH})
+endif()
+
 endif()
 if( MSVC OR MINGW )
   # libuuid required for FOLDERID_Profile usage in lib/Support/Windows/Path.inc.
-- 
2.27.0.windows.1

