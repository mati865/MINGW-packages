From f907ae04e12bd93b0bc0bdd2daf07e245d260faf Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Sat, 27 Sep 2014 15:42:50 +0100
Subject: [PATCH 11/14] MSYS2: Changes to various system calls

openRootTerminal(), runCommandInTerminal()
getSUCommand(), isRootRunning()

MSYS2 behaviour changes for these:
*Terminal() runs msys2_shell.bat
getSUCommand() returns "sh.exe -c "
isRootRunning() returns false
---
 src/terminal.cpp  | 12 +++++++++++-
 src/unixcommand.h |  6 ++++++
 src/wmhelper.cpp  |  5 ++++-
 src/wmhelper.h    |  1 +
 4 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/src/terminal.cpp b/src/terminal.cpp
index bec9273..eb4293c 100644
--- a/src/terminal.cpp
+++ b/src/terminal.cpp
@@ -205,7 +205,12 @@ void Terminal::openRootTerminal()
 {
   if (m_selectedTerminal == ctn_AUTOMATIC)
   {
-    if (UnixCommand::getLinuxDistro() == ectn_MOOOSLINUX && UnixCommand::hasTheExecutable(ctn_RXVT_TERMINAL))
+    if (UnixCommand::getLinuxDistro() == ectn_MSYS2)
+    {
+        QString cmd = ctn_MSYS2_SH + UnixCommand::getMSYS2Root() + QLatin1String("/msys2_shell.bat");
+        m_process->startDetached(cmd);
+    }
+    else if (UnixCommand::getLinuxDistro() == ectn_MOOOSLINUX && UnixCommand::hasTheExecutable(ctn_RXVT_TERMINAL))
     {
       QString cmd = WMHelper::getSUCommand() + " \"" + ctn_RXVT_TERMINAL +
           " -name Urxvt -title Urxvt \"";
@@ -359,6 +364,11 @@ void Terminal::runCommandInTerminal(const QStringList &commandList)
 
   if (m_selectedTerminal == ctn_AUTOMATIC)
   {
+    if (UnixCommand::getLinuxDistro() == ectn_MSYS2)
+    {
+      QString cmd = ctn_MSYS2_SH + UnixCommand::getMSYS2Root() + QLatin1String("/msys2_shell.bat -c ") + ftemp->fileName();
+      m_process->start(cmd);
+    }
     if (UnixCommand::getLinuxDistro() == ectn_MOOOSLINUX && UnixCommand::hasTheExecutable(ctn_RXVT_TERMINAL))
     {
       QString cmd =
diff --git a/src/unixcommand.h b/src/unixcommand.h
index 7560c2a..056a776 100644
--- a/src/unixcommand.h
+++ b/src/unixcommand.h
@@ -117,10 +117,16 @@ public:
   static bool hasTheExecutable( const QString& exeName );
   static bool isAppRunning(const QString &appName, bool justOneInstance = false);
 
+#if defined(_WIN32)
+  static bool isRootRunning(){
+    return false;
+  }
+#else
   static bool isRootRunning(){
     int uid = geteuid();
     return (uid == 0); //Returns TRUE if root is running Octopi
   }
+#endif
 
   static QString getMSYS2Root(){
     if (m_msys2Root.isEmpty())
diff --git a/src/wmhelper.cpp b/src/wmhelper.cpp
index 487c41d..9eaabe3 100644
--- a/src/wmhelper.cpp
+++ b/src/wmhelper.cpp
@@ -298,7 +298,10 @@ QString WMHelper::getGKSUCommand(){
 QString WMHelper::getSUCommand(){
   QString result(ctn_NO_SU_COMMAND);
 
-  if (isXFCERunning() && (UnixCommand::hasTheExecutable(ctn_GKSU_2))){
+  if (UnixCommand::getLinuxDistro() == ectn_MSYS2){
+    return QLatin1String("sh.exe -c ");
+  }
+  else if (isXFCERunning() && (UnixCommand::hasTheExecutable(ctn_GKSU_2))){
     result = getGKSUCommand();
   }
   else if (isKDERunning() && UnixCommand::hasTheExecutable(ctn_KDESU)){
diff --git a/src/wmhelper.h b/src/wmhelper.h
index 8a941a4..aaff77e 100644
--- a/src/wmhelper.h
+++ b/src/wmhelper.h
@@ -25,6 +25,7 @@
 
 const QString ctn_NO_SU_COMMAND("none");
 const QString ctn_ROOT_SH("/bin/sh -c ");
+const QString ctn_MSYS2_SH("cmd.exe /c ");
 
 const QString ctn_KDESU("kdesu");
 
-- 
2.4.2

